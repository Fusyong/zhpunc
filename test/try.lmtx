%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% 演示：
%% 在processors类回调中干预断行；
%% tex.linebreak()的用法；
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \setuppapersize[A4,landscape]
\setuppapersize[A4]

% 中文配置
\mainlanguage[cn]
\language[cn]
\setscript[hanzi] % 汉字脚本（断行）
\setupalign[hanging,hz] %行末标点悬挂

% 汉字字体配置
\usetypescriptfile[mscore]
\usebodyfont   [mschinese,20pt]
% \usebodyfont   [mschinese-light,20pt]
% \setupbodyfont [mschinese-literate,20pt]
% \usebodyfont   [mschinese-literate,20pt]
% \definebodyfontenvironment[24pt]
% \definebodyfontenvironment[18pt]
% 定义字体
% \definefont[kaiti][name:kaiti*default at 24pt]

% 行距设置
\setupinterlinespace[line=1.6em]
% 缩进设置
\setupindenting[yes, 2em, first]
\setuphead[indentnext=yes] %标题后段落缩进，默认是no


% 标点宽度测试
\def\test[#1][#2]{%
    {\showglyphs\showboxes%
    \inframed[width=#1,align=flushleft,offset=0em]{\hbox{#2}}%
    }%
}

%%%%% 显式视觉调试信息 %%%%
\showboxes
\showframe
\showglyphs
% \showmakeup
% \tracingnodes1 %1,2
\replacemissingcharacters


%%%%%%%%%%%%% 使用模块(夹注要在标点压缩后) %%%%%%%%%%%%%

% 标点压缩
% pattern: quanjiao(default), kaiming, banjiao, yuanyang
% hangjian: false(default), ture
% spacequad: 0.5(default)
\usemodule[zhpunc][pattern=banjiao, spacequad=0.5, hangjian=true]

% 夹注
% default: fontname=\tf, fontsize=10.5pt, interlinespace=0.08em
\usemodule[jiazhu][fontname=\tf, fontsize=10.5pt, interlinespace=0.08em]

% 竖排
\usemodule[vtypeset]

% 标点宽度测试
\def\test[#1][#2]{%
    {\showglyphs\showboxes%
        \inframed[width=#1,align=flushleft,offset=0em]{\hbox{#2}}%
    }%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\starttext


\zhangj{\zhuanmh{子程子}曰：「\shumhs{大學}，\zhuanmh{孔氏}之遺書，而初學入德之門也。」於今可見古人爲學次第者，獨賴此篇之存，而\shumhs{論}、\shumhs{孟}次之。學者必由是而學焉，則庶乎其不差矣。}

\shumh{大學}之道，在明明德，在親民，在止於至善。
\jiazh{\zhuanmh{程子}曰：「親，當作新。」○大學者，大人之學也。明，明之也。明德者，人之所得乎天，而虚靈不昧，以具衆理而應萬事者也。但爲氣禀所拘，人欲所蔽，則有時而昏；然其本體之明，則有未嘗息者。故學者當因其所發而遂明之，以復其初也。新者，革其舊之謂也，言既自明其明德，又當推以及人，使之亦有以去其舊染之污也。止者，必至於是而不遷之意。至善，則事理當然之極也。言明明德、新民，皆當至於至善之地而不遷。蓋必其有以盡夫天理之極，而無一毫人欲之私也。此三者，大學之綱領也。}
知止而后有定，定而后能静，静而后能安，安而后能慮，慮而后能得。
\jiazh{后，與後同，後放此。○止者，所當止之地，即至善之所在也。知之，則志有定向。静，謂心不妄動。安，謂所處而安。慮，謂處事精詳。得，謂得其所止。}
物有本末，事有終始，知所先後，則近道矣。
\jiazh{明德爲本，新民爲末。知止爲始，能得爲終。本始所先，末終所後。此結上文兩節之意。}
古之欲明明德於天下者，先治其國；欲治其國者，先齊其家；欲齊其家者，先修其身；欲修其身者，先正其心；欲正其心者，先誠其意；欲誠其意者，先致其知；致知在格物。
\jiazh{治，平聲，後放此。○明明德於天下者，使天下之人皆有以明其明德也。心者，身之所主也。誠，實也。意者，心之所發也。實其心之所發，欲其一於善而無自欺也。致，推極也。知，猶識也。推極吾之知識，欲其所知無不盡也。格，至也。物，猶事也。窮至事物之理，欲其極處無不到也。此八者，大學之條目也。}
物格而后知至，知至而后意誠，意誠而后心正，心正而后身修，身修而后家齊，家齊而后國治，國治而后天下平。
\jiazh{治，去聲，後放此。○物格者，物理之極處無不到也。知至者，吾心之所知無不盡也。知既盡，則意可得而實矣，意既實，則心可得而正矣。修身以上，明明德之事也。齊家以下，新民之事也。物格知至，則知所止矣。意誠以下，則皆得所止之序也。}
自天子以至於庶人，壹是皆以修身爲本。
\jiazh{壹是，一切也。正心以上，皆所以修身也。齊家以下，則舉此而措之耳。}
其本亂而末治者否矣，其所厚者薄，而其所薄者厚，未之有也！
\jiazh{本，謂身也。所厚，謂家也。此兩節結上文兩節之意。}


我。你

% <node :   3213 <=   3184 =>   3026 : hlist box> 。      0       0       0       -503424 nil     nil     nil
    % <node :    nil <=   3142 =>   1714 : glue userskip>     0       65536   65536   2       2
    % <node :   3142 <=   1714 =>   3390 : kern userkern>     0       nil
    % <node :   1714 <=   3390 =>   1708 : glyph unset>       。
    % <node :   3390 <=   1708 =>    nil : kern userkern>     -655500 nil

a{\raise 1.5ex\hbox to 0pt{\hss b}}c

% <node :   3364 <=   3490 =>   3505 : hlist box> b       0       947052  18648   -755136 nil     nil     nil
    % <node :    nil <=   3468 =>   3475 : glue userskip>     0       65536   65536   2       2
    % <node :   3468 <=   3475 =>    nil : glyph unset>       b

% 标点压缩在前夹注在后缺失凸排（？？夹注造成的parinitrightskip）
% ...
% <node :   4827 <=   3650 =>   4830 : glyph unset>       ，
% <node :   3650 <=   4830 =>   4994 : kern userkern>     0       nil
% <node :   4830 <=   4994 =>   5426 : glue parinitrightskip>     0       0       0       0       0
% <node :   4994 <=   5426 =>   5447 : glue rightskip>    0       0       0       0       0
% <node :   5426 <=   5447 =>    nil : glue righthangskip>        0       0       0       0       0

% 标点压缩在后夹注在前正确凸排
% ...
% <node :   4917 <=   4040 =>   5467 : glyph unset>       ，
% <node :   4040 <=   5467 =>   4920 : kern rightmarginkern>      -852150 nil
% <node :   5467 <=   4920 =>   4385 : kern userkern>     0       nil
% <node :   4920 <=   4385 =>   5484 : glue rightskip>    0       0       0       0       0
% <node :   4385 <=   5484 =>    nil : glue righthangskip>        0       0       0       0       0

\stoptext